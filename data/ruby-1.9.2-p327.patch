From 9c3bf9bec4927510c881ee807de5d37026fa89a8 Mon Sep 17 00:00:00 2001
From: nobu <nobu@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Fri, 11 May 2012 05:09:58 +0000
Subject: [PATCH 01/11] 	* ext/bigdecimal/bigdecimal.c (PUSH): to prevent VALUE
 from GC, 	  must not cast it to unsigned long, which may be shorter than
 	  VALUE, and the result can be mere garbage.

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@35619 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog                   | 6 ++++++
 ext/bigdecimal/bigdecimal.c | 2 +-
 version.h                   | 8 ++++----
 3 files changed, 11 insertions(+), 5 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index dc283e9..b6c28b4 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,9 @@
+Fri May 11 14:09:48 2012  Nobuyoshi Nakada  <nobu@ruby-lang.org>
+
+	* ext/bigdecimal/bigdecimal.c (PUSH): to prevent VALUE from GC,
+	  must not cast it to unsigned long, which may be shorter than
+	  VALUE, and the result can be mere garbage.
+
 Fri Apr 20 12:40:19 2012  Eric Hodel  <drbrain@segment7.net>
 
 	* lib/rubygems/ssl_certs/AddTrustExternalCARoot.pem:  Removed to avoid
diff --git a/ext/bigdecimal/bigdecimal.c b/ext/bigdecimal/bigdecimal.c
index 817fc13..1a712e9 100644
--- a/ext/bigdecimal/bigdecimal.c
+++ b/ext/bigdecimal/bigdecimal.c
@@ -35,7 +35,7 @@ VALUE rb_cBigDecimal;
 
 /* MACRO's to guard objects from GC by keeping them in stack */
 #define ENTER(n) volatile VALUE vStack[n];int iStack=0
-#define PUSH(x)  vStack[iStack++] = (unsigned long)(x);
+#define PUSH(x)  vStack[iStack++] = (VALUE)(x);
 #define SAVE(p)  PUSH(p->obj);
 #define GUARD_OBJ(p,y) {p=y;SAVE(p);}
 
diff --git a/version.h b/version.h
index f5a6112..a1d36c2 100644
--- a/version.h
+++ b/version.h
@@ -1,13 +1,13 @@
 #define RUBY_VERSION "1.9.2"
-#define RUBY_PATCHLEVEL 320
+#define RUBY_PATCHLEVEL 321
 #define RUBY_VERSION_MAJOR 1
 #define RUBY_VERSION_MINOR 9
 #define RUBY_VERSION_TEENY 1
 
 #define RUBY_RELEASE_YEAR 2012
-#define RUBY_RELEASE_MONTH 4
-#define RUBY_RELEASE_DAY 20
-#define RUBY_RELEASE_DATE "2012-04-20"
+#define RUBY_RELEASE_MONTH 5
+#define RUBY_RELEASE_DAY 11
+#define RUBY_RELEASE_DATE "2012-05-11"
 
 #include "ruby/version.h"
 
-- 
1.9.1


From 86988c7d5eda207175e70683a48d87e54a44beca Mon Sep 17 00:00:00 2001
From: nobu <nobu@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Fri, 18 May 2012 09:13:47 +0000
Subject: [PATCH 02/11] [ruby-dev:45650]

* lib/mkmf.rb (MakeMakefile#configuration): keep space at end of
  OUTFLAG and COUTFLAG.  [ruby-dev:45650]


git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@35698 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog   | 5 +++++
 lib/mkmf.rb | 5 +++--
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index b6c28b4..c3c737c 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,8 @@
+Fri May 18 18:13:44 2012  Nobuyoshi Nakada  <nobu@ruby-lang.org>
+
+	* lib/mkmf.rb (MakeMakefile#configuration): keep space at end of
+	  OUTFLAG and COUTFLAG.  [ruby-dev:45650]
+
 Fri May 11 14:09:48 2012  Nobuyoshi Nakada  <nobu@ruby-lang.org>
 
 	* ext/bigdecimal/bigdecimal.c (PUSH): to prevent VALUE from GC,
diff --git a/lib/mkmf.rb b/lib/mkmf.rb
index cba14ce..1019a5d 100644
--- a/lib/mkmf.rb
+++ b/lib/mkmf.rb
@@ -1491,8 +1491,9 @@ LIBRUBY = #{CONFIG['LIBRUBY']}
 LIBRUBY_A = #{CONFIG['LIBRUBY_A']}
 LIBRUBYARG_SHARED = #$LIBRUBYARG_SHARED
 LIBRUBYARG_STATIC = #$LIBRUBYARG_STATIC
-OUTFLAG = #{OUTFLAG}
-COUTFLAG = #{COUTFLAG}
+empty =
+OUTFLAG = #{OUTFLAG}$(empty)
+COUTFLAG = #{COUTFLAG}$(empty)
 
 RUBY_EXTCONF_H = #{$extconf_h}
 cflags   = #{CONFIG['cflags']}
-- 
1.9.1


From 1e3c758b28cce83c76d1a95d6ca56bb35017c39d Mon Sep 17 00:00:00 2001
From: svn <svn@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Fri, 18 May 2012 09:14:02 +0000
Subject: [PATCH 03/11] * 2012-05-18

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@35700 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 version.h | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/version.h b/version.h
index a1d36c2..d283701 100644
--- a/version.h
+++ b/version.h
@@ -6,8 +6,8 @@
 
 #define RUBY_RELEASE_YEAR 2012
 #define RUBY_RELEASE_MONTH 5
-#define RUBY_RELEASE_DAY 11
-#define RUBY_RELEASE_DATE "2012-05-11"
+#define RUBY_RELEASE_DAY 18
+#define RUBY_RELEASE_DATE "2012-05-18"
 
 #include "ruby/version.h"
 
-- 
1.9.1


From 2c2b8637c39969bb870e74d313dc376a79167e9a Mon Sep 17 00:00:00 2001
From: nobu <nobu@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Fri, 18 May 2012 09:19:41 +0000
Subject: [PATCH 04/11] * version.h: bump up patchlevel.

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@35701 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 version.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/version.h b/version.h
index d283701..93ad561 100644
--- a/version.h
+++ b/version.h
@@ -1,5 +1,5 @@
 #define RUBY_VERSION "1.9.2"
-#define RUBY_PATCHLEVEL 321
+#define RUBY_PATCHLEVEL 322
 #define RUBY_VERSION_MAJOR 1
 #define RUBY_VERSION_MINOR 9
 #define RUBY_VERSION_TEENY 1
-- 
1.9.1


From ccb34ee954409f5856eb74c2ce9682bf5e40f17f Mon Sep 17 00:00:00 2001
From: knu <knu@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Mon, 21 May 2012 07:28:54 +0000
Subject: [PATCH 05/11] * ext/syslog/syslog.c (mSyslog_inspect): Make sure self
 is a   module before calling rb_class2name().

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@35742 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog           | 5 +++++
 ext/syslog/syslog.c | 2 ++
 2 files changed, 7 insertions(+)

diff --git a/ChangeLog b/ChangeLog
index c3c737c..7eb0f2d 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,8 @@
+Mon May 21 16:27:24 2012  Akinori MUSHA  <knu@iDaemons.org>
+
+	* ext/syslog/syslog.c (mSyslog_inspect): Make sure self is a
+	  module before calling rb_class2name().
+
 Fri May 18 18:13:44 2012  Nobuyoshi Nakada  <nobu@ruby-lang.org>
 
 	* lib/mkmf.rb (MakeMakefile#configuration): keep space at end of
diff --git a/ext/syslog/syslog.c b/ext/syslog/syslog.c
index 8eec81e..2c91c9f 100644
--- a/ext/syslog/syslog.c
+++ b/ext/syslog/syslog.c
@@ -164,6 +164,8 @@ static VALUE mSyslog_inspect(VALUE self)
 {
     char buf[1024];
 
+    Check_Type(self, T_MODULE);
+
     if (syslog_opened) {
 	snprintf(buf, sizeof(buf),
 	  "<#%s: opened=true, ident=\"%s\", options=%d, facility=%d, mask=%d>",
-- 
1.9.1


From 2c7e082f47dd0dd3ef27ac9e6d0763d306effebe Mon Sep 17 00:00:00 2001
From: svn <svn@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Mon, 21 May 2012 07:29:04 +0000
Subject: [PATCH 06/11] * 2012-05-21

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@35743 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 version.h | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/version.h b/version.h
index 93ad561..3ccf945 100644
--- a/version.h
+++ b/version.h
@@ -6,8 +6,8 @@
 
 #define RUBY_RELEASE_YEAR 2012
 #define RUBY_RELEASE_MONTH 5
-#define RUBY_RELEASE_DAY 18
-#define RUBY_RELEASE_DATE "2012-05-18"
+#define RUBY_RELEASE_DAY 21
+#define RUBY_RELEASE_DATE "2012-05-21"
 
 #include "ruby/version.h"
 
-- 
1.9.1


From ac3be749d5e94731559e50cf1d9d3dafe11f04d9 Mon Sep 17 00:00:00 2001
From: nobu <nobu@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Tue, 22 May 2012 02:09:55 +0000
Subject: [PATCH 07/11] merge revision(s) 27939,29703,29704,30164:

	* ruby.c (ruby_init_loadpath_safe): use real path for non-shared
	  build.
	* configure.in (LIBRUBY_RELATIVE): use rpath token expansion.
	* tool/rbinstall.rb (bin-comm): prepend prolog shell script if
	  necessary.
	* ruby.c (ruby_init_loadpath_safe): relatively called non-shared
	  binary cannot be found in PATH, so use given pathname.


git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@35755 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog         | 13 +++++++++++++
 configure.in      | 13 ++++++++++---
 ruby.c            |  9 ++++++---
 tool/rbinstall.rb | 24 +++++++++++++++++++++++-
 version.h         |  6 +++---
 5 files changed, 55 insertions(+), 10 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 7eb0f2d..7200dc7 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,16 @@
+Tue May 22 11:09:52 2012  Nobuyoshi Nakada  <nobu@ruby-lang.org>
+
+	* ruby.c (ruby_init_loadpath_safe): use real path for non-shared
+	  build.
+
+	* configure.in (LIBRUBY_RELATIVE): use rpath token expansion.
+
+	* tool/rbinstall.rb (bin-comm): prepend prolog shell script if
+	  necessary.
+
+	* ruby.c (ruby_init_loadpath_safe): relatively called non-shared
+	  binary cannot be found in PATH, so use given pathname.
+
 Mon May 21 16:27:24 2012  Akinori MUSHA  <knu@iDaemons.org>
 
 	* ext/syslog/syslog.c (mSyslog_inspect): Make sure self is a
diff --git a/configure.in b/configure.in
index 3f94ac8..52b9320 100644
--- a/configure.in
+++ b/configure.in
@@ -2107,6 +2107,8 @@ AC_ARG_ENABLE(shared,
        AS_HELP_STRING([--enable-shared], [build a shared library for Ruby]),
        [enable_shared=$enableval])
 LIBRUBYARG_SHARED='-l$(RUBY_SO_NAME)'
+libprefix='$(libdir)'
+LIBRUBY_RELATIVE=no
 if test "$enable_shared" = 'yes'; then
   LIBRUBY='$(LIBRUBY_SO)'
   LIBRUBYARG='$(LIBRUBYARG_SHARED)'
@@ -2122,6 +2124,10 @@ if test "$enable_shared" = 'yes'; then
     [linux* | gnu* | k*bsd*-gnu | atheos* | kopensolaris*-gnu], [
 	LIBRUBY_DLDFLAGS='-Wl,-soname,lib$(RUBY_SO_NAME).so.$(MAJOR).$(MINOR)'
 	LIBRUBY_ALIASES='lib$(RUBY_SO_NAME).so.$(MAJOR).$(MINOR) lib$(RUBY_SO_NAME).so'
+	if test "$load_relative" = yes; then
+	    LIBRUBY_RPATHFLAGS="'-Wl,-rpath,\$\${ORIGIN}/../lib'"
+	    LIBRUBY_RELATIVE=yes
+	fi
 	],
     [freebsd*|dragonfly*], [
 	SOLIBS='$(LIBS)'
@@ -2175,8 +2181,7 @@ if test "$enable_shared" = 'yes'; then
 	LIBRUBY_LDSHARED='$(CC) -dynamiclib'
 	if test "$load_relative" = yes; then
 	    libprefix='@executable_path/../lib'
-	else
-	    libprefix='$(libdir)'
+	    LIBRUBY_RELATIVE=yes
 	fi
 	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-install_name '${libprefix}'/$(LIBRUBY_SO)'
 	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-current_version $(MAJOR).$(MINOR).$(TEENY)'
@@ -2194,10 +2199,12 @@ if test "$enable_shared" = 'yes'; then
 	])
 fi
 if test "$enable_rpath" = yes; then
-    LIBRUBY_RPATHFLAGS="${linker_flag}-R ${linker_flag}\$(libdir) -L\$(libdir)"
+    test -z "$LIBRUBY_RPATHFLAGS" || LIBRUBY_RPATHFLAGS="$LIBRUBY_RPATHFLAGS "
+    LIBRUBY_RPATHFLAGS="$LIBRUBY_RPATHFLAGS${linker_flag}-R ${linker_flag}${libprefix} -L\$(libdir)"
     LIBRUBYARG_SHARED="$LIBRUBY_RPATHFLAGS $LIBRUBYARG_SHARED"
     LIBRUBYARG_STATIC="$LIBRUBY_RPATHFLAGS $LIBRUBYARG_STATIC"
 fi
+AC_SUBST(LIBRUBY_RELATIVE)
 
 LDFLAGS="-L. $LDFLAGS"
 AC_SUBST(ARCHFILE)
diff --git a/ruby.c b/ruby.c
index 541ef88..945f183 100644
--- a/ruby.c
+++ b/ruby.c
@@ -370,9 +370,12 @@ ruby_init_loadpath_safe(int safe_level)
 #elif defined(HAVE_DLADDR)
     Dl_info dli;
     if (dladdr((void *)(VALUE)expand_include_path, &dli)) {
-	VALUE fname = rb_str_new_cstr(dli.dli_fname);
-	sopath = rb_file_absolute_path(fname, Qnil);
-	rb_str_resize(fname, 0);
+	VALUE rb_realpath_internal(VALUE basedir, VALUE path, int strict);
+	char fbuf[MAXPATHLEN];
+	char *f = dln_find_file_r(dli.dli_fname, getenv(PATH_ENV), fbuf, sizeof(fbuf));
+	VALUE fname = rb_str_new_cstr(f ? f : dli.dli_fname);
+	rb_str_freeze(fname);
+	sopath = rb_realpath_internal(Qnil, fname, 1);
     }
     else {
 	sopath = rb_str_new(0, 0);
diff --git a/tool/rbinstall.rb b/tool/rbinstall.rb
index 79aee2e..5f68cc1 100755
--- a/tool/rbinstall.rb
+++ b/tool/rbinstall.rb
@@ -300,6 +300,7 @@ enable_shared = CONFIG["ENABLE_SHARED"] == 'yes'
 dll = CONFIG["LIBRUBY_SO"]
 lib = CONFIG["LIBRUBY"]
 arc = CONFIG["LIBRUBY_A"]
+load_relative = configure_args.include?("--enable-load-relative")
 
 install?(:local, :arch, :bin, :'bin-arch') do
   prepare "binary commands", bindir
@@ -371,6 +372,23 @@ install?(:doc, :capi) do
   install_recursive "doc/capi", capidir, :mode => $data_mode
 end
 
+if load_relative
+  PROLOG_SCRIPT = <<EOS
+#!/bin/sh\n# -*- ruby -*-
+bindir=`#{CONFIG["CHDIR"]} "${0%/*}" 2>/dev/null; pwd`
+EOS
+  if CONFIG["LIBRUBY_RELATIVE"] != 'yes' and libpathenv = CONFIG["LIBPATHENV"]
+    pathsep = File::PATH_SEPARATOR
+    PROLOG_SCRIPT << <<EOS
+prefix="${bindir%/bin}"
+export #{libpathenv}="$prefix/lib${#{libpathenv}#{pathsep}+#{pathsep}$#{libpathenv}}"
+EOS
+  end
+  PROLOG_SCRIPT << %Q[exec "$bindir/#{ruby_install_name}" -x "$0" "$@"\n]
+else
+  PROLOG_SCRIPT = nil
+end
+
 install?(:local, :comm, :bin, :'bin-comm') do
   prepare "command scripts", bindir
 
@@ -416,7 +434,11 @@ install?(:local, :comm, :bin, :'bin-comm') do
       shebang = f.gets
       body = f.read
     end
-    shebang.sub!(/^\#!.*?ruby\b/) {"#!" + ruby_shebang}
+    if PROLOG_SCRIPT
+      shebang.sub!(/\A(\#!.*?ruby\b)?/) {PROLOG_SCRIPT + ($1 || "#!ruby\n")}
+    else
+      shebang.sub!(/\A\#!.*?ruby\b/) {"#!" + ruby_shebang}
+    end
     shebang.sub!(/\r$/, '')
     body.gsub!(/\r$/, '')
 
diff --git a/version.h b/version.h
index 3ccf945..41c141d 100644
--- a/version.h
+++ b/version.h
@@ -1,13 +1,13 @@
 #define RUBY_VERSION "1.9.2"
-#define RUBY_PATCHLEVEL 322
+#define RUBY_PATCHLEVEL 323
 #define RUBY_VERSION_MAJOR 1
 #define RUBY_VERSION_MINOR 9
 #define RUBY_VERSION_TEENY 1
 
 #define RUBY_RELEASE_YEAR 2012
 #define RUBY_RELEASE_MONTH 5
-#define RUBY_RELEASE_DAY 21
-#define RUBY_RELEASE_DATE "2012-05-21"
+#define RUBY_RELEASE_DAY 22
+#define RUBY_RELEASE_DATE "2012-05-22"
 
 #include "ruby/version.h"
 
-- 
1.9.1


From a840645f916c61b3e56d0c2a12db366b6a7625c6 Mon Sep 17 00:00:00 2001
From: naruse <naruse@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Mon, 15 Apr 2013 02:00:45 +0000
Subject: [PATCH 08/11] merge revision(s) 34278:

	* cont.c (cont_restore_0): prevent optimizing out `sp'. sp is used for
	  reserving a memory space with ALLOCA_N for restoring machine stack
	  stored in cont->machine_stack, but clang optimized out it (and
	  maybe #5851 is also caused by this).
	  This affected TestContinuation#test_check_localvars.

	* cont.c (cont_restore_1): revert workaround introduced in r32201.


git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@40303 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog | 10 ++++++++++
 cont.c    |  4 ++--
 version.h | 10 +++++-----
 3 files changed, 17 insertions(+), 7 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 7200dc7..1bb6039 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,13 @@
+Mon Apr 15 10:56:55 2013  NARUSE, Yui  <naruse@ruby-lang.org>
+
+	* cont.c (cont_restore_0): prevent optimizing out `sp'. sp is used for
+	  reserving a memory space with ALLOCA_N for restoring machine stack
+	  stored in cont->machine_stack, but clang optimized out it (and
+	  maybe #5851 is also caused by this).
+	  This affected TestContinuation#test_check_localvars.
+
+	* cont.c (cont_restore_1): revert workaround introduced in r32201.
+
 Tue May 22 11:09:52 2012  Nobuyoshi Nakada  <nobu@ruby-lang.org>
 
 	* ruby.c (ruby_init_loadpath_safe): use real path for non-shared
diff --git a/cont.c b/cont.c
index d1c2d6c..e6f6b6d 100644
--- a/cont.c
+++ b/cont.c
@@ -476,7 +476,7 @@ cont_restore_0(rb_context_t *cont, VALUE *addr_in_prev_frame)
 	    if (&space[0] > end) {
 # ifdef HAVE_ALLOCA
 		volatile VALUE *sp = ALLOCA_N(VALUE, &space[0] - end);
-		(void)sp;
+		space[0] = *sp;
 # else
 		cont_restore_0(cont, &space[0]);
 # endif
@@ -492,7 +492,7 @@ cont_restore_0(rb_context_t *cont, VALUE *addr_in_prev_frame)
 	    if (&space[STACK_PAD_SIZE] < end) {
 # ifdef HAVE_ALLOCA
 		volatile VALUE *sp = ALLOCA_N(VALUE, end - &space[STACK_PAD_SIZE]);
-		(void)sp;
+		space[0] = *sp;
 # else
 		cont_restore_0(cont, &space[STACK_PAD_SIZE-1]);
 # endif
diff --git a/version.h b/version.h
index 41c141d..2e57f5b 100644
--- a/version.h
+++ b/version.h
@@ -1,13 +1,13 @@
 #define RUBY_VERSION "1.9.2"
-#define RUBY_PATCHLEVEL 323
+#define RUBY_PATCHLEVEL 324
 #define RUBY_VERSION_MAJOR 1
 #define RUBY_VERSION_MINOR 9
 #define RUBY_VERSION_TEENY 1
 
-#define RUBY_RELEASE_YEAR 2012
-#define RUBY_RELEASE_MONTH 5
-#define RUBY_RELEASE_DAY 22
-#define RUBY_RELEASE_DATE "2012-05-22"
+#define RUBY_RELEASE_YEAR 2013
+#define RUBY_RELEASE_MONTH 4
+#define RUBY_RELEASE_DAY 15
+#define RUBY_RELEASE_DATE "2013-04-15"
 
 #include "ruby/version.h"
 
-- 
1.9.1


From e80d0a9631cdfebc53c1a111eb2162fe3f1dc67c Mon Sep 17 00:00:00 2001
From: naruse <naruse@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Mon, 15 Apr 2013 05:58:19 +0000
Subject: [PATCH 09/11] merge revision(s) 34306:

	* ext/json/parser/parser.rl (json_string_unescape): workaround fix
	  for over optimization of GCC 4.7. [ruby-core:42085] [Bug #5888]
	  http://gcc.gnu.org/bugzilla/show_bug.cgi?id=51862


git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@40305 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog                 | 6 ++++++
 ext/json/parser/parser.c  | 2 +-
 ext/json/parser/parser.rl | 2 +-
 version.h                 | 2 +-
 4 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 1bb6039..004c362 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,9 @@
+Mon Apr 15 14:57:43 2013  NARUSE, Yui  <naruse@ruby-lang.org>
+
+	* ext/json/parser/parser.rl (json_string_unescape): workaround fix
+	  for over optimization of GCC 4.7. [ruby-core:42085] [Bug #5888]
+	  http://gcc.gnu.org/bugzilla/show_bug.cgi?id=51862
+
 Mon Apr 15 10:56:55 2013  NARUSE, Yui  <naruse@ruby-lang.org>
 
 	* cont.c (cont_restore_0): prevent optimizing out `sp'. sp is used for
diff --git a/ext/json/parser/parser.c b/ext/json/parser/parser.c
index 42f9bf2..bd8199a 100644
--- a/ext/json/parser/parser.c
+++ b/ext/json/parser/parser.c
@@ -1283,6 +1283,7 @@ static VALUE json_string_unescape(VALUE result, char *string, char *stringEnd)
 {
     char *p = string, *pe = string, *unescape;
     int unescape_len;
+    char buf[4];
 
     while (pe < stringEnd) {
         if (*pe == '\\') {
@@ -1315,7 +1316,6 @@ static VALUE json_string_unescape(VALUE result, char *string, char *stringEnd)
                     if (pe > stringEnd - 4) {
                         return Qnil;
                     } else {
-                        char buf[4];
                         UTF32 ch = unescape_unicode((unsigned char *) ++pe);
                         pe += 3;
                         if (UNI_SUR_HIGH_START == (ch & 0xFC00)) {
diff --git a/ext/json/parser/parser.rl b/ext/json/parser/parser.rl
index 9fafaed..2f4e939 100644
--- a/ext/json/parser/parser.rl
+++ b/ext/json/parser/parser.rl
@@ -382,6 +382,7 @@ static VALUE json_string_unescape(VALUE result, char *string, char *stringEnd)
 {
     char *p = string, *pe = string, *unescape;
     int unescape_len;
+    char buf[4];
 
     while (pe < stringEnd) {
         if (*pe == '\\') {
@@ -414,7 +415,6 @@ static VALUE json_string_unescape(VALUE result, char *string, char *stringEnd)
                     if (pe > stringEnd - 4) {
                         return Qnil;
                     } else {
-                        char buf[4];
                         UTF32 ch = unescape_unicode((unsigned char *) ++pe);
                         pe += 3;
                         if (UNI_SUR_HIGH_START == (ch & 0xFC00)) {
diff --git a/version.h b/version.h
index 2e57f5b..84645ee 100644
--- a/version.h
+++ b/version.h
@@ -1,5 +1,5 @@
 #define RUBY_VERSION "1.9.2"
-#define RUBY_PATCHLEVEL 324
+#define RUBY_PATCHLEVEL 325
 #define RUBY_VERSION_MAJOR 1
 #define RUBY_VERSION_MINOR 9
 #define RUBY_VERSION_TEENY 1
-- 
1.9.1


From 2b93dbd8e7e3d71dc4cb4c7e381974176b134c5b Mon Sep 17 00:00:00 2001
From: hone <hone@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Sun, 22 Dec 2013 23:41:16 +0000
Subject: [PATCH 10/11] merge revision(s) 43775: [Fixes GH-458]
 https://github.com/ruby/ruby/pull/458

   * util.c (ruby_strtod): ignore too long fraction part, which does not
     affect the result.

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@44353 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog |  5 +++++
 util.c    | 14 ++++++++++++--
 version.h |  8 ++++----
 3 files changed, 21 insertions(+), 6 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 004c362..e18f0af 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,8 @@
+Fri Nov 22 12:43:52 2013  Nobuyoshi Nakada  <nobu@ruby-lang.org>
+
+	* util.c (ruby_strtod): ignore too long fraction part, which does not
+	  affect the result.
+
 Mon Apr 15 14:57:43 2013  NARUSE, Yui  <naruse@ruby-lang.org>
 
 	* ext/json/parser/parser.rl (json_string_unescape): workaround fix
diff --git a/util.c b/util.c
index 26f46ba..c75ad74 100644
--- a/util.c
+++ b/util.c
@@ -852,6 +852,11 @@ extern void *MALLOC(size_t);
 #else
 #define MALLOC malloc
 #endif
+#ifdef FREE
+extern void FREE(void*);
+#else
+#define FREE free
+#endif
 
 #ifndef Omit_Private_Memory
 #ifndef PRIVATE_MEM
@@ -1142,7 +1147,7 @@ Balloc(int k)
 #endif
 
     ACQUIRE_DTOA_LOCK(0);
-    if ((rv = freelist[k]) != 0) {
+    if (k <= Kmax && (rv = freelist[k]) != 0) {
         freelist[k] = rv->next;
     }
     else {
@@ -1152,7 +1157,7 @@ Balloc(int k)
 #else
         len = (sizeof(Bigint) + (x-1)*sizeof(ULong) + sizeof(double) - 1)
                 /sizeof(double);
-        if (pmem_next - private_mem + len <= PRIVATE_mem) {
+        if (k <= Kmax && pmem_next - private_mem + len <= PRIVATE_mem) {
             rv = (Bigint*)pmem_next;
             pmem_next += len;
         }
@@ -1171,6 +1176,10 @@ static void
 Bfree(Bigint *v)
 {
     if (v) {
+        if (v->k > Kmax) {
+            FREE(v);
+            return;
+        }
         ACQUIRE_DTOA_LOCK(0);
         v->next = freelist[v->k];
         freelist[v->k] = v;
@@ -2212,6 +2221,7 @@ break2:
         for (; c >= '0' && c <= '9'; c = *++s) {
 have_dig:
             nz++;
+            if (nf > DBL_DIG * 2) continue;
             if (c -= '0') {
                 nf += nz;
                 for (i = 1; i < nz; i++)
diff --git a/version.h b/version.h
index 84645ee..e7443a1 100644
--- a/version.h
+++ b/version.h
@@ -1,13 +1,13 @@
 #define RUBY_VERSION "1.9.2"
-#define RUBY_PATCHLEVEL 325
+#define RUBY_PATCHLEVEL 326
 #define RUBY_VERSION_MAJOR 1
 #define RUBY_VERSION_MINOR 9
 #define RUBY_VERSION_TEENY 1
 
 #define RUBY_RELEASE_YEAR 2013
-#define RUBY_RELEASE_MONTH 4
-#define RUBY_RELEASE_DAY 15
-#define RUBY_RELEASE_DATE "2013-04-15"
+#define RUBY_RELEASE_MONTH 12
+#define RUBY_RELEASE_DAY 23
+#define RUBY_RELEASE_DATE "2013-12-23"
 
 #include "ruby/version.h"
 
-- 
1.9.1


From d1b23d1f78a9262c053283e5a7753ef7b99d4e59 Mon Sep 17 00:00:00 2001
From: naruse <naruse@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Wed, 22 Jan 2014 17:41:54 +0000
Subject: [PATCH 11/11] merge revision(s) 36533:

 * tool/ytab.sed: fix for Bison 2.6.




git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_1_9_2@44682 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 tool/ytab.sed | 6 ++++++
 version.h     | 8 ++++----
 2 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/tool/ytab.sed b/tool/ytab.sed
index f956c06..46317db 100755
--- a/tool/ytab.sed
+++ b/tool/ytab.sed
@@ -5,6 +5,12 @@ i\
 a\
 #endif
 }
+/^extern int yydebug;/{
+i\
+#ifndef yydebug
+a\
+#endif
+}
 /^yydestruct.*yymsg/,/#endif/{
   /^yydestruct/{
     /parser/!{
diff --git a/version.h b/version.h
index e7443a1..67b4478 100644
--- a/version.h
+++ b/version.h
@@ -1,13 +1,13 @@
 #define RUBY_VERSION "1.9.2"
-#define RUBY_PATCHLEVEL 326
+#define RUBY_PATCHLEVEL 327
 #define RUBY_VERSION_MAJOR 1
 #define RUBY_VERSION_MINOR 9
 #define RUBY_VERSION_TEENY 1
 
-#define RUBY_RELEASE_YEAR 2013
-#define RUBY_RELEASE_MONTH 12
+#define RUBY_RELEASE_YEAR 2014
+#define RUBY_RELEASE_MONTH 1
 #define RUBY_RELEASE_DAY 23
-#define RUBY_RELEASE_DATE "2013-12-23"
+#define RUBY_RELEASE_DATE "2014-01-23"
 
 #include "ruby/version.h"
 
-- 
1.9.1

